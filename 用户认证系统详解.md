# 用户认证系统详解

## 1. JWT (JSON Web Token) 认证

### 什么是JWT？
JWT是一种开放标准(RFC 7519)，用于在各方之间安全地传输信息。它是一个紧凑的、URL安全的令牌，包含三个部分：

- **Header（头部）**：包含令牌类型和签名算法
- **Payload（载荷）**：包含声明（claims），如用户ID、过期时间等
- **Signature（签名）**：用于验证令牌的完整性

### JWT的优势
1. **无状态**：服务器不需要存储会话信息
2. **跨域支持**：可以在不同域名间使用
3. **移动友好**：适合移动应用和API
4. **可扩展**：可以包含自定义信息


### JWT实现示例
```javascript
// 生成JWT
const token = jwt.sign(
  { userId: user.id, email: user.email },
  process.env.JWT_SECRET,
  { expiresIn: process.env.JWT_EXPIRES_IN }
);

// 验证JWT
const decoded = jwt.verify(token, process.env.JWT_SECRET);
```

## 2. 密码安全处理

### 密码哈希（Password Hashing）
**为什么需要哈希？**
- 明文存储密码极不安全
- 即使数据库泄露，攻击者也无法直接获取原始密码

**bcrypt算法特点：**
- **加盐（Salt）**：防止彩虹表攻击
- **自适应**：可调整计算复杂度
- **慢哈希**：故意设计得较慢，增加暴力破解成本

### 密码验证流程
注册：用户密码 → bcrypt.hash() → 存储哈希值
登录：用户输入 → bcrypt.compare(输入, 存储的哈希) → 返回true/false

### bcrypt使用示例
```javascript
// 密码哈希
const saltRounds = 12;
const hashedPassword = await bcrypt.hash(password, saltRounds);

// 密码验证
const isValid = await bcrypt.compare(password, hashedPassword);
```

## 3. Express中间件（Middleware）

### 什么是中间件？
中间件是在请求-响应循环中执行的函数，可以：
- 执行代码
- 修改请求和响应对象
- 结束请求-响应循环
- 调用下一个中间件

### 认证中间件的作用
```javascript
// 典型的认证中间件流程
function authMiddleware(req, res, next) {
  // 1. 从请求头获取token
  const token = req.header('Authorization')?.replace('Bearer ', '');
  
  // 2. 验证token有效性
  if (!token) {
    return res.status(401).json({ success: false, message: '未提供认证令牌' });
  }
  
  try {
    // 3. 解析用户信息
    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    
    // 4. 将用户信息附加到req对象
    req.user = decoded;
    
    // 5. 调用next()继续处理
    next();
  } catch (error) {
    res.status(401).json({ success: false, message: '无效的认证令牌' });
  }
}
```

## 4. 数据验证（Validation）

### 为什么需要验证？
- **安全性**：防止恶意输入
- **数据完整性**：确保数据格式正确
- **用户体验**：提供清晰的错误信息

### express-validator的使用
```javascript
// 验证规则示例
const { body, validationResult } = require('express-validator');

const validateRegister = [
  body('email')
    .isEmail()
    .normalizeEmail()
    .withMessage('请提供有效的邮箱地址'),
  body('password')
    .isLength({ min: 6 })
    .withMessage('密码至少需要6个字符'),
  body('username')
    .trim()
    .isLength({ min: 2, max: 30 })
    .withMessage('用户名长度应在2-30个字符之间')
];

// 处理验证错误
const handleValidationErrors = (req, res, next) => {
  const errors = validationResult(req);
  if (!errors.isEmpty()) {
    return res.status(422).json({
      success: false,
      message: '数据验证失败',
      errors: errors.array()
    });
  }
  next();
};
```

## 5. 安全最佳实践

### 环境变量管理
```bash
# .env 文件示例
DATABASE_URL="postgresql://username:password@localhost:5432/database"
JWT_SECRET="your-super-secret-jwt-key-here"
JWT_EXPIRES_IN="7d"
PORT=3001
NODE_ENV="development"
FRONTEND_URL="http://localhost:3000"
```

### CORS（跨域资源共享）
```javascript
// CORS配置示例
const cors = require('cors');

app.use(cors({
  origin: process.env.FRONTEND_URL || 'http://localhost:3000',
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization']
}));
```

### 安全头部设置
```javascript
// 使用helmet中间件
const helmet = require('helmet');
app.use(helmet());

// 手动设置安全头部
app.use((req, res, next) => {
  res.setHeader('X-Content-Type-Options', 'nosniff');
  res.setHeader('X-Frame-Options', 'DENY');
  res.setHeader('X-XSS-Protection', '1; mode=block');
  next();
});
```

## 6. 错误处理

### 统一错误处理
```javascript
// 全局错误处理中间件
app.use((err, req, res, next) => {
  console.error('Error:', err.stack);
  
  // 开发环境显示详细错误
  if (process.env.NODE_ENV === 'development') {
    return res.status(err.status || 500).json({
      success: false,
      message: err.message,
      stack: err.stack
    });
  }
  
  // 生产环境隐藏敏感信息
  res.status(err.status || 500).json({
    success: false,
    message: err.status === 500 ? '服务器内部错误' : err.message
  });
});
```

### 常见HTTP状态码
- **200 OK**：请求成功
- **201 Created**：资源创建成功
- **400 Bad Request**：请求参数错误
- **401 Unauthorized**：未认证或认证失败
- **403 Forbidden**：已认证但无权限
- **404 Not Found**：资源不存在
- **422 Unprocessable Entity**：数据验证失败
- **500 Internal Server Error**：服务器内部错误

## 7. API设计模式

### RESTful API设计

用户认证相关

POST /api/auth/register  - 用户注册
POST /api/auth/login     - 用户登录
GET  /api/auth/me        - 获取当前用户信息
POST /api/auth/logout    - 用户登出

超市管理

GET    /api/stores       - 获取用户的超市列表
POST   /api/stores       - 创建新超市
PUT    /api/stores/:id   - 更新超市信息
DELETE /api/stores/:id   - 删除超市

购物清单

GET    /api/items        - 获取购物清单
POST   /api/items        - 添加商品
PUT    /api/items/:id    - 更新商品
DELETE /api/items/:id    - 删除商品


### 响应格式标准化
```javascript
// 成功响应
{
  "success": true,
  "data": {
    "user": {
      "id": 1,
      "email": "user@example.com",
      "username": "testuser"
    }
  },
  "message": "登录成功"
}

// 错误响应
{
  "success": false,
  "error": "邮箱或密码错误",
  "code": "INVALID_CREDENTIALS"
}

// 验证错误响应
{
  "success": false,
  "message": "数据验证失败",
  "errors": [
    {
      "field": "email",
      "message": "请提供有效的邮箱地址"
    }
  ]
}
```

## 8. 数据库集成（Prisma）

### Prisma Schema示例
```prisma
model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  username  String
  passwordHash String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  stores    Store[]
  shoppingItems ShoppingItem[]
  
  @@map("users")
}

model Store {
  id        Int      @id @default(autoincrement())
  name      String
  color     String   @default("#3B82F6")
  userId    Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  shoppingItems ShoppingItem[]
  
  @@map("stores")
}
```

### Prisma Client使用
```javascript
const { PrismaClient } = require('@prisma/client');
const prisma = new PrismaClient();

// 创建用户
const user = await prisma.user.create({
  data: {
    email: 'user@example.com',
    username: 'testuser',
    passwordHash: hashedPassword
  }
});

// 查找用户（包含关联数据）
const user = await prisma.user.findUnique({
  where: { email: 'user@example.com' },
  include: {
    stores: true,
    shoppingItems: true
  }
});

// 更新用户
const updatedUser = await prisma.user.update({
  where: { id: userId },
  data: { username: 'newusername' }
});

// 删除用户（级联删除相关数据）
await prisma.user.delete({
  where: { id: userId }
});
```

## 9. 控制器模式

### 用户认证控制器示例
```javascript
class AuthController {
  // 用户注册
  static async register(req, res, next) {
    try {
      const { email, username, password } = req.body;
      
      // 检查用户是否已存在
      const existingUser = await prisma.user.findUnique({
        where: { email }
      });
      
      if (existingUser) {
        return res.status(400).json({
          success: false,
          message: '该邮箱已被注册'
        });
      }
      
      // 哈希密码
      const passwordHash = await bcrypt.hash(password, 12);
      
      // 创建用户
      const user = await prisma.user.create({
        data: {
          email,
          username,
          passwordHash
        }
      });
      
      // 生成JWT
      const token = jwt.sign(
        { userId: user.id, email: user.email },
        process.env.JWT_SECRET,
        { expiresIn: process.env.JWT_EXPIRES_IN }
      );
      
      res.status(201).json({
        success: true,
        data: {
          user: {
            id: user.id,
            email: user.email,
            username: user.username
          },
          token
        },
        message: '注册成功'
      });
    } catch (error) {
      next(error);
    }
  }
  
  // 用户登录
  static async login(req, res, next) {
    try {
      const { email, password } = req.body;
      
      // 查找用户
      const user = await prisma.user.findUnique({
        where: { email }
      });
      
      if (!user) {
        return res.status(401).json({
          success: false,
          message: '邮箱或密码错误'
        });
      }
      
      // 验证密码
      const isValidPassword = await bcrypt.compare(password, user.passwordHash);
      
      if (!isValidPassword) {
        return res.status(401).json({
          success: false,
          message: '邮箱或密码错误'
        });
      }
      
      // 生成JWT
      const token = jwt.sign(
        { userId: user.id, email: user.email },
        process.env.JWT_SECRET,
        { expiresIn: process.env.JWT_EXPIRES_IN }
      );
      
      res.json({
        success: true,
        data: {
          user: {
            id: user.id,
            email: user.email,
            username: user.username
          },
          token
        },
        message: '登录成功'
      });
    } catch (error) {
      next(error);
    }
  }
}
```

## 10. 开发和调试技巧

### 日志记录
```javascript
// 请求日志中间件
app.use((req, res, next) => {
  const timestamp = new Date().toISOString();
  console.log(`${timestamp} - ${req.method} ${req.path}`);
  
  // 记录请求体（排除敏感信息）
  if (req.body && Object.keys(req.body).length > 0) {
    const sanitizedBody = { ...req.body };
    if (sanitizedBody.password) sanitizedBody.password = '[HIDDEN]';
    console.log('Request Body:', sanitizedBody);
  }
  
  next();
});
```

### 健康检查端点
```javascript
// 健康检查路由
app.get('/health', async (req, res) => {
  try {
    // 测试数据库连接
    await prisma.$queryRaw`SELECT 1`;
    
    res.json({
      status: 'healthy',
      timestamp: new Date().toISOString(),
      database: 'connected',
      version: process.env.npm_package_version || '1.0.0'
    });
  } catch (error) {
    res.status(503).json({
      status: 'unhealthy',
      timestamp: new Date().toISOString(),
      database: 'disconnected',
      error: error.message
    });
  }
});
```

### API测试示例
```javascript
// 使用 curl 测试API

// 注册用户
curl -X POST http://localhost:3001/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "username": "testuser",
    "password": "password123"
  }'

// 登录用户
curl -X POST http://localhost:3001/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "password123"
  }'

// 获取当前用户信息（需要JWT）
curl -X GET http://localhost:3001/api/auth/me \
  -H "Authorization: Bearer YOUR_JWT_TOKEN_HERE"
```

## 11. 部署考虑

### 生产环境配置
```bash
# 生产环境变量
NODE_ENV=production
PORT=3001
DATABASE_URL="postgresql://prod_user:prod_password@prod_host:5432/prod_db"
JWT_SECRET="super-secure-production-jwt-secret-key"
JWT_EXPIRES_IN="1d"
FRONTEND_URL="https://your-frontend-domain.com"
```

### Docker配置示例
```dockerfile
# Dockerfile
FROM node:18-alpine

WORKDIR /app

# 复制package文件
COPY package*.json ./
RUN npm ci --only=production

# 复制源代码
COPY . .

# 生成Prisma客户端
RUN npx prisma generate

# 暴露端口
EXPOSE 3001

# 启动应用
CMD ["npm", "start"]
```

### 安全检查清单
- [ ] 使用HTTPS
- [ ] 设置强JWT密钥
- [ ] 配置适当的CORS策略
- [ ] 实施速率限制
- [ ] 启用安全头部
- [ ] 定期更新依赖
- [ ] 监控和日志收集
- [ ] 数据库连接加密
- [ ] 环境变量安全管理

## 总结

这个用户认证系统为购物清单应用提供了：

1. **安全的用户管理**：注册、登录、身份验证
2. **数据隔离**：每个用户拥有独立的数据空间
3. **可扩展架构**：支持未来功能扩展
4. **生产就绪**：包含安全最佳实践
5. **开发友好**：清晰的错误处理和调试支持

通过这套认证系统，你的购物清单应用将具备完整的用户管理功能，确保数据安全和用户隐私保护。